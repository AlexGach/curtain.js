/*
* Curtain.js - Create an unique page transitioning system
* ---
* Version: 1.1
* Copyright 2011, Victor Coulon (http://victorcoulon.fr)
* Released under the MIT Licence
*/
(function(e,c,a,g){var d="curtain",f={scrollSpeed:400,bodyHeight:0,linksArray:[],mobile:false,scrollButtons:{},menu:null};function b(i,h){this.element=i;this.options=e.extend({},f,h);this.didScroll=false;this._defaults=f;this._name=d;this._ignoreHashChange=false;this.init()}b.prototype={init:function(){var h=this;this.$element=e(this.element);this.$li=e(this.element).find(">li");e.Android=(navigator.userAgent.match(/Android/i));e.iPhone=((navigator.userAgent.match(/iPhone/i))||(navigator.userAgent.match(/iPod/i)));e.iPad=((navigator.userAgent.match(/iPad/i)));if(e.iPhone||e.iPad||e.Android){this.options.mobile=true;this.$li.css({position:"relative"});this.$element.find(".fixed").css({position:"absolute"})}if(h.options.menu){h.options.scrollButtons.up=h.options.menu.find('[href="#up"]');h.options.scrollButtons.down=h.options.menu.find('[href="#down"]');if(e.iPhone||e.iPad){h.$element.css({position:"fixed",top:0,left:0,right:0,bottom:0,"-webkit-overflow-scrolling":"touch",overflow:"auto"});h.options.menu.css({position:"absolute"})}}e(c).load(function(){h.setDimensions();h.$li.eq(0).addClass("current");if(!h.options.mobile){if(h.$li.eq(1).length){h.$li.eq(1).nextAll().css({display:"none"})}}h.setEvents();h.setLinks();h.isHashIsOnList(location.hash.substring(1))})},scrollToPosition:function(m){var h=null,j=this,l=(this.options.mobile)?this.$element:e("body, html");if(e("html, body").is(":animated")){return false}if(m==="up"||m=="down"){var k=this.$element.find(".current"),i=(m==="up")?k.prev():k.next();h=i.attr("data-position")||null;if(k.find(".step").length){if(!k.find(".current-step").length){k.find(".step").eq(0).addClass("current-step")}var n=(m==="up")?k.find(".current-step").prev(".step"):k.find(".current-step").next(".step");if(n.length){h=(this.options.mobile)?n.position().top+parseInt(k.attr("data-position"),10):n.offset().top}}if(h){l.animate({scrollTop:h},this.options.scrollSpeed)}}else{h=e("#"+m).attr("data-position")||null;if(h){l.animate({scrollTop:h},this.options.scrollSpeed).scrollTop(h)}}},scrollEvent:function(){var h=this;setInterval(function(){if(h.didScroll){h.didScroll=false;var i=e(a).scrollTop(),m=h.$element.find(".current"),l=m.find(".fixed"),k=m.find(".step"),p=parseInt(m.attr("data-position"),10),n=parseInt(m.attr("data-height"),10),o=e(c).height();if(i<p&&m.index()>0){h._ignoreHashChange=true;if(m.prev().attr("id")){c.location.hash=m.prev().attr("id")}m.removeClass("current").css({marginTop:0}).nextAll().css({display:"none"}).end().prev().addClass("current").css({display:"block"})}else{if(i<(p+m.height())){m.css({marginTop:-(i-p)});if(l.length){var j=parseInt(l.attr("data-top"),10);if((i-p+o)>=n&&l.css("position")==="fixed"){l.css({position:"absolute",top:Math.abs(i-p+j)})}else{if((i-p+o)<=n&&l.css("position")==="absolute"){l.css({position:"fixed",top:j})}}}if(k.length){e.each(k,function(q,r){if(e(r).offset().top<=i+5&&(e(r).offset().top+e(r).outerHeight())>=i+5){if(!e(r).hasClass("current-step")){k.removeClass("current-step");e(r).addClass("current-step")}}})}}else{h._ignoreHashChange=true;if(m.next().attr("id")){c.location.hash=m.next().attr("id")}m.removeClass("current").css({display:"none"}).next().addClass("current").nextAll().css({display:"block"})}}}},5)},scrollMobileEvent:function(){var h=this;setInterval(function(){if(h.didScroll){h.didScroll=false;var i=h.$element.scrollTop(),k=h.$element.find(".current"),j=k.find(".step"),n=parseInt(k.attr("data-position"),10),l=parseInt(k.attr("data-height"),10),m=e(c).height();if(i+10<n&&k.index()>0){k.removeClass("current").prev().addClass("current")}else{if(i+10<(n+k.height())){if(j.length){e.each(j,function(o,p){if((e(p).position().top+n)<=i&&((e(p).position().top+n)+e(p).outerHeight())>=i){if(!e(p).hasClass("current-step")){j.removeClass("current-step");e(p).addClass("current-step")}}})}}else{k.removeClass("current").next().addClass("current")}}}},5)},setDimensions:function(){var k=e(c).height(),j=0,i=false,h=null;this.$li.each(function(l){var n=e(this);i=n.hasClass("cover");if(i){n.css({height:k,zIndex:999-l}).attr("data-height",k).attr("data-position",j);j+=k}else{h=(n.outerHeight()<=k)?k:n.outerHeight();n.css({minHeight:h,zIndex:999-l}).attr("data-height",h).attr("data-position",j);j+=h}if(n.find(".fixed").length){var m=n.find(".fixed").css("top");n.find(".fixed").attr("data-top",m)}});if(!this.options.mobile){this.setBodyHeight()}},setEvents:function(){var h=this;e(c).on("resize",function(){h.setDimensions()});if(h.options.mobile){h.$element.on("scroll",function(){h.didScroll=true;h.scrollMobileEvent()})}else{e(c).on("scroll",function(){h.didScroll=true;h.scrollEvent()})}e(a).on("keydown",function(i){if(i.keyCode===38||i.keyCode===37){h.scrollToPosition("up");i.preventDefault();return false}if(i.keyCode===40||i.keyCode===39){h.scrollToPosition("down");i.preventDefault();return false}});if(h.options.scrollButtons){if(h.options.scrollButtons.up){h.options.scrollButtons.up.on("click",function(i){i.preventDefault();h.scrollToPosition("up")})}if(h.options.scrollButtons.down){h.options.scrollButtons.down.on("click",function(i){i.preventDefault();h.scrollToPosition("down")})}}if("onhashchange" in c){c.addEventListener("hashchange",function(){if(h._ignoreHashChange===false){h.isHashIsOnList(location.hash.substring(1))}h._ignoreHashChange=false},false)}},setBodyHeight:function(){var i=0;this.$li.each(function(){i+=e(this).height()});this.options.bodyHeight=i;e("body").height(i)},setLinks:function(){var h=this;this.$li.each(function(){var i=e(this).attr("id")||0;h.options.linksArray.push(i)})},setHash:function(h){c.location.hash=h},isHashIsOnList:function(i){var h=this;e.each(h.options.linksArray,function(j,k){if(k===i){h.scrollToPosition(i);return false}})}};e.fn[d]=function(h){return this.each(function(){if(!e.data(this,"plugin_"+d)){e.data(this,"plugin_"+d,new b(this,h))}})}})(jQuery,window,document);